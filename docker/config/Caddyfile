{
    email {$ACME_EMAIL}
    # Enable admin API only in development
    admin off
}

{$DOMAIN} {
    tls {$ACME_EMAIL}

    # Root directory pointing to the frontend static files
    root * /srv/frontend

    # Enable compression
    encode gzip

    # Handle SPA routing and static files
    try_files {path} /index.html
    file_server

    # Cache static assets
    @assets {
        path /assets/*
    }
    header @assets {
        Cache-Control "public, max-age=31536000"
        # Prevent caching for development
        ?no-cache "no-store, must-revalidate" {$NODE_ENV}==local
    }

    # Security headers
    header {
        X-Frame-Options "SAMEORIGIN"
        X-XSS-Protection "1; mode=block"
        X-Content-Type-Options "nosniff"
    }

    # tRPC endpoint
    handle /trpc/* {
        reverse_proxy backend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port {server_port}
        }
    }

    # WebSocket endpoint
    handle /ws/* {
        reverse_proxy backend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
        }
    }
}
