{
    email {$ACME_EMAIL}
    admin off
    # debug
    # log {
    #     level DEBUG
    # }
}

{$DOMAIN} {
    tls {$ACME_EMAIL}

    # Handle API routes first
    handle /trpc/* {
        reverse_proxy backend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up X-Forwarded-Proto {scheme}
            header_up X-Forwarded-Host {host}
            header_up X-Forwarded-Port {server_port}
        }
    }

    # WebSocket endpoint - make it more specific
    @websocket {
        path /ws*
        header Connection *Upgrade*
        header Upgrade websocket
    }

    handle @websocket {
        reverse_proxy backend:3000 {
            header_up Host {host}
            header_up X-Real-IP {remote_host}
            header_up X-Forwarded-For {remote_host}
            header_up Connection "Upgrade"
            header_up Upgrade "websocket"
        }
    }

    # Static file handling - make it the last handler
    handle {
        root * /srv/frontend
        encode gzip

        # Cache static assets
        @assets {
            path /assets/*
        }
        header @assets {
            Cache-Control "public, max-age=31536000"
            # Prevent caching for development
            ?no-cache "no-store, must-revalidate" {$NODE_ENV}==local
        }

        # Security headers
        header {
            X-Frame-Options "SAMEORIGIN"
            X-XSS-Protection "1; mode=block"
            X-Content-Type-Options "nosniff"
        }

        try_files {path} /index.html
        file_server
    }
}
